(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{332:function(_,v,e){"use strict";e.r(v);var c=e(0),t=Object(c.a)({},(function(){var _=this,v=_.$createElement,e=_._self._c||v;return e("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[e("blockquote",[e("p",[_._v("针对面试，知道往往是不够的，重要的是你"),e("strong",[_._v("能否在面试的场景下")]),_._v("，"),e("strong",[_._v("利用你的回答突显你的优点")]),_._v("，刻意练习+费曼技巧，助你拿到大厂 offer，后续的文章中我也会讲述我如何在大二就进入腾讯实习。")])]),_._v(" "),e("h2",{attrs:{id:"问题描述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[_._v("#")]),_._v(" 问题描述")]),_._v(" "),e("p",[_._v("你能否讲解一下"),e("code",[_._v("TCP")]),_._v("的三次握手与四次挥手呢？")]),_._v(" "),e("blockquote",[e("p",[_._v("面试官如果从整体到局部入手，那我们就先讲讲"),e("strong",[_._v("整个三次握手和四次挥手的过程")]),_._v("，但不要忘记，讲的同时应该适当"),e("strong",[_._v("体现你对该知识点掌握的深度和广度")]),_._v("，具体怎么说，我们后面慢慢道来。")])]),_._v(" "),e("h2",{attrs:{id:"三次握手"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三次握手"}},[_._v("#")]),_._v(" 三次握手")]),_._v(" "),e("p",[_._v("所谓的"),e("code",[_._v("握手")]),_._v("即一次发包到接收的过程，可能从客户端发送到服务端，也可能从服务端发送到客户端。")]),_._v(" "),e("h3",{attrs:{id:"过程描述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#过程描述"}},[_._v("#")]),_._v(" 过程描述")]),_._v(" "),e("p",[_._v("先上一张"),e("code",[_._v("TCP报文结构")]),_._v("图，待会我们会回来看这张图：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9quces1wkj30lt0l8wge.jpg",alt:"TCP报文结构"}})]),_._v(" "),e("p",[_._v("先上三次握手的流程图：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucebqk8j30u00u0gs9.jpg",alt:"三次握手"}})]),_._v(" "),e("p",[_._v("接下来我们来详细讲解下上图的过程：")]),_._v(" "),e("ul",[e("li",[e("p",[_._v("客户主机发起连接请求，设置"),e("code",[_._v("SYN")]),_._v("标志位为"),e("code",[_._v("1")]),_._v("，同时客户端"),e("code",[_._v("随机")]),_._v("选择了一个初始序号"),e("code",[_._v("client_isn")]),_._v("，并且存放在"),e("code",[_._v("TCP报文")]),_._v("字段的"),e("code",[_._v("序号")]),_._v("中，如下图：\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucbz1tej31cc0hc77a.jpg",alt:"第一次握手：SYN报文"}})])]),_._v(" "),e("li",[e("p",[_._v("接下来，当服务端接收到该报文后，会为其分配"),e("code",[_._v("TCP 缓存和变量")]),_._v("（这使得TCP容易受到被称为"),e("code",[_._v("SYN 洪泛攻击")]),_._v("的拒绝服务攻击）紧接着，服务端会返回一个"),e("code",[_._v("SYNACK 报文")]),_._v("到客户端，其中"),e("code",[_._v("SYN")]),_._v("标志位为"),e("code",[_._v("1")]),_._v("，"),e("code",[_._v("确认号")]),_._v("设置为"),e("code",[_._v("client_isn + 1")]),_._v("，并且选一个自己的初始序号"),e("code",[_._v("server_isn")]),_._v("，并放置在"),e("code",[_._v("序号")]),_._v("字段中，如下图：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9quccdw39j31bu0gwq63.jpg",alt:"第二次握手：SYNACK报文"}})])]),_._v(" "),e("li",[e("p",[_._v("当收到服务器发来的"),e("code",[_._v("SYNACK")]),_._v("报文段后，客户端也需要给该连接分配缓存和变量，然后再次发送一个确认报文给服务端，其中，"),e("code",[_._v("SYN")]),_._v("标志位设置为"),e("code",[_._v("0")]),_._v("，将"),e("code",[_._v("确认号")]),_._v("设置为"),e("code",[_._v("server_isn + 1")]),_._v("，另外，此次报文可以携带负载数据：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucg3z08j31bo0hetbv.jpg",alt:"第三次握手：ACK报文"}})])])]),_._v(" "),e("h3",{attrs:{id:"细节拓展"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#细节拓展"}},[_._v("#")]),_._v(" 细节拓展")]),_._v(" "),e("ul",[e("li",[_._v("三次握手的状态转换图（建议达到能默写下来的熟练程度）\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucf8y0aj31040u00z8.jpg",alt:"三次握手状态图"}})]),_._v(" "),e("li",[_._v("服务器为什么要使用特殊的初始序号"),e("code",[_._v("server_isn")]),_._v("？这为什么是必要的呢？")])]),_._v(" "),e("p",[_._v("这个细节和"),e("code",[_._v("问题深究第3题")]),_._v("是一致的，服务器使用"),e("code",[_._v("特定的初始序列号 server_isn")]),_._v("（从"),e("code",[_._v("源")]),_._v("和"),e("code",[_._v("目的地IP")]),_._v("和"),e("code",[_._v("端口")]),_._v("的"),e("code",[_._v("散列")]),_._v("中获取）可以用来抵御SYN洪水攻击。具体为什么，以及什么是"),e("code",[_._v("SYN 洪泛攻击")]),_._v("，问题深究部分我们会再详谈。")]),_._v(" "),e("blockquote",[e("p",[_._v("为了下文描述方便，我们将三次握手分别称为："),e("code",[_._v("SYN 报文")]),_._v("、"),e("code",[_._v("SYNACK 报文")]),_._v("、"),e("code",[_._v("ACK 报文")])])]),_._v(" "),e("h3",{attrs:{id:"问题深究"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题深究"}},[_._v("#")]),_._v(" 问题深究")]),_._v(" "),e("h4",{attrs:{id:"_1-为什么要三次握手而不是两次？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么要三次握手而不是两次？"}},[_._v("#")]),_._v(" 1.为什么要三次握手而不是两次？")]),_._v(" "),e("p",[_._v("简单来说，三次握手的目的是为了让双方"),e("strong",[_._v("验证各自的接收能力和发送能力")]),_._v("。")]),_._v(" "),e("ul",[e("li",[e("p",[_._v("第一次握手，A 发送"),e("code",[_._v("SYN")]),_._v("到"),e("code",[_._v("B")]),_._v("，"),e("code",[_._v("B")]),_._v("接收到了后，能确认什么呢？\n显然，"),e("code",[_._v("B")]),_._v("能确认"),e("code",[_._v("A")]),_._v("的"),e("code",[_._v("发送")]),_._v("能力和"),e("code",[_._v("B")]),_._v("的"),e("code",[_._v("接收")]),_._v("能力；")])]),_._v(" "),e("li",[e("p",[_._v("第二次握手，"),e("code",[_._v("B")]),_._v("发送"),e("code",[_._v("SYNACK")]),_._v("到"),e("code",[_._v("A")]),_._v("，"),e("code",[_._v("A")]),_._v("接收到后，能确认什么呢？\n"),e("code",[_._v("A")]),_._v("能确认"),e("code",[_._v("B")]),_._v("的发送能力和"),e("code",[_._v("A")]),_._v("自己的接收能力，此外，"),e("code",[_._v("A")]),_._v("收到了"),e("code",[_._v("SYNACK")]),_._v("，那么说明前面"),e("code",[_._v("A")]),_._v("发的"),e("code",[_._v("SYN")]),_._v("成功到达"),e("code",[_._v("B")]),_._v("的手中，所以也能确认"),e("code",[_._v("A")]),_._v("自己的"),e("code",[_._v("发送")]),_._v("能力和"),e("code",[_._v("B")]),_._v("的"),e("code",[_._v("接收")]),_._v("能力；至此，"),e("code",[_._v("A")]),_._v("已经确认了双方各自的发送能力和接收能力都是"),e("code",[_._v("OK")]),_._v("的，因此转为"),e("code",[_._v("ESTABLISHED")]),_._v("状态；")])]),_._v(" "),e("li",[e("p",[_._v("第三次握手，"),e("code",[_._v("A")]),_._v("发送"),e("code",[_._v("ACK")]),_._v("到"),e("code",[_._v("B")]),_._v("，"),e("code",[_._v("B")]),_._v("接收后，能确认什么呢？")]),_._v(" "),e("p",[_._v("直接的，"),e("code",[_._v("B")]),_._v("能确认"),e("code",[_._v("A")]),_._v("的"),e("code",[_._v("发送")]),_._v("能力和"),e("code",[_._v("B")]),_._v("的"),e("code",[_._v("接收")]),_._v("能力，另外由于"),e("code",[_._v("B")]),_._v("能收到"),e("code",[_._v("ACK")]),_._v("说明前面发送的"),e("code",[_._v("SYNACK")]),_._v("已经成功被接受了，说明能确认"),e("code",[_._v("A")]),_._v("的"),e("code",[_._v("接收")]),_._v("能力和"),e("code",[_._v("B")]),_._v("的"),e("code",[_._v("发送")]),_._v("能力。")])])]),_._v(" "),e("p",[_._v("如果使用两次握手，就不能确认上述所说的四种能力，那么就会导致问题。")]),_._v(" "),e("p",[e("strong",[_._v("假定不采用第三次报文握手，那么只要"),e("code",[_._v("B")]),_._v("发出确认，新的连接就建立了。")])]),_._v(" "),e("p",[_._v("现假定一种异常情况，即"),e("code",[_._v("A")]),_._v("发出的"),e("code",[_._v("SYN")]),_._v("报文段并没有丢失，而是在某些网络节点长时间滞留了，以致延误到连接释放后的某个时间才到达"),e("code",[_._v("B")]),_._v("。本来这是一个早已失效的报文段。但"),e("code",[_._v("B")]),_._v("收到此失效的连接请求报文段后，却误以为是"),e("code",[_._v("A")]),_._v("又发出一次新的连接请求，于是就向"),e("code",[_._v("A")]),_._v("发出确认报文段，同意建立连接。")]),_._v(" "),e("p",[_._v("由于现在"),e("code",[_._v("A")]),_._v("并没有发出建立连接的请求，因此不会理睬"),e("code",[_._v("B")]),_._v("的确认，也不会向"),e("code",[_._v("B")]),_._v("发送数据，但"),e("code",[_._v("B")]),_._v("却以为新的运输连接已经建立了，并一直等待"),e("code",[_._v("A")]),_._v("发来的数据。"),e("code",[_._v("B")]),_._v("的许多资源就这样白白浪费了。")]),_._v(" "),e("h4",{attrs:{id:"_2-两个tcp建立请求相互之间同时发起时会发生什么？建立几个连接？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-两个tcp建立请求相互之间同时发起时会发生什么？建立几个连接？"}},[_._v("#")]),_._v(" 2.两个TCP建立请求相互之间同时发起时会发生什么？建立几个连接？")]),_._v(" "),e("p",[_._v("首先理解题意，我们知道"),e("code",[_._v("三次握手")]),_._v("正是建立"),e("code",[_._v("TCP连接")]),_._v("的过程，我们假设 A 是客户端，B 是服务端：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucdt5djj30w80gw76i.jpg",alt:"rfc793-同时启动"}})]),_._v(" "),e("p",[_._v("这里先给大家讲一下上图中一些符号的含义：")]),_._v(" "),e("ul",[e("li",[_._v("右箭头 (--\x3e) ：从 A 发送到 B 的 TCP 报文段，且 B 接收到了；")]),_._v(" "),e("li",[_._v("左箭头 (<--) ：从 B 发送到 A 的 TCP 报文段，且 A 接收到了；")]),_._v(" "),e("li",[_._v("省略号 (...) ：TCP 报文段仍在网络中（delayed）；")]),_._v(" "),e("li",[_._v('丢失 ("XXX") ：TCP 报文段丢失或者被拒绝。')]),_._v(" "),e("li",[_._v("注释会放在括号中；")]),_._v(" "),e("li",[_._v("TCP 状态代表了处于中间的报文段到达之后的状态（AFTER）；")]),_._v(" "),e("li",[_._v("报文段的内容只显示了序列号（SEQ）、控制符（CTL）和 ACK，其余内容被省略。")])]),_._v(" "),e("p",[_._v("接下来我们详细来看看上图中，两个请求"),e("strong",[_._v("同时相互发起")]),_._v("时，两个"),e("code",[_._v("TCP")]),_._v("均会经历如下状态的转换：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucfse7dj30ja0n0q55.jpg",alt:"同步请求的状态转换"}})]),_._v(" "),e("p",[_._v("上述的状态转换图可以跟前面的三次握手的转换图进行对比理解，同时发起的两个请求最终"),e("code",[_._v("只会建立一个连接")]),_._v("。")]),_._v(" "),e("blockquote",[e("p",[e("code",[_._v("SYN-RECEIVED")]),_._v(" 跟 "),e("code",[_._v("SYN-RCVD")]),_._v("是一样的，前者"),e("code",[_._v("rcf793")]),_._v("中的描述方法，后者是《计算机网络-自顶向下方法》中的使用方法。")])]),_._v(" "),e("h4",{attrs:{id:"_3-客户端正在和服务端建立-tcp-连接，然而当服务器变-syn-rcvd-后，此时一个旧的-syn-报文-又到达了，服务器会如何处理？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-客户端正在和服务端建立-tcp-连接，然而当服务器变-syn-rcvd-后，此时一个旧的-syn-报文-又到达了，服务器会如何处理？"}},[_._v("#")]),_._v(" 3. 客户端正在和服务端建立 TCP 连接，然而当服务器变 SYN-RCVD 后，此时一个旧的 SYN 报文 又到达了，服务器会如何处理？")]),_._v(" "),e("p",[_._v("其实这道题更加深挖了"),e("code",[_._v("TCP 建立连接")]),_._v("的过程，我们可以在"),e("code",[_._v("rfc793")]),_._v("中了解到详细信息。")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9quccupbmj30us0iuwh4.jpg",alt:"rfc793-RST"}})]),_._v(" "),e("p",[_._v("从上图可以看到，第三行就是旧的"),e("code",[_._v("SYN 连接")]),_._v("到达服务器时，第四行是服务器照常返回，第五行是客户端给服务端发送"),e("code",[_._v("RST 报文")]),_._v("，将服务端重置为"),e("code",[_._v("LISTEN")]),_._v("。")]),_._v(" "),e("p",[_._v("我们需要从上图了解到的一点是，服务端在"),e("code",[_._v("SYN_RECEIVED")]),_._v("状态下，接收到旧的"),e("code",[_._v("SYN 报文")]),_._v("时是"),e("strong",[_._v("不能作出判断")]),_._v("的，而是照常返回，当客户端接收到该报文后发现异常，才会发送"),e("code",[_._v("RST 报文")]),_._v("，重置连接。")]),_._v(" "),e("p",[_._v("关于"),e("code",[_._v("RST 报文")]),_._v("，我一开始也很疑惑，直到看到"),e("code",[_._v("rfc793 原文")]),_._v("：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucgob2uj30ve09cq6o.jpg",alt:"rfc793-page33"}})]),_._v(" "),e("p",[_._v("确实说明了"),e("code",[_._v("TCP B")]),_._v("不能检测这个旧的"),e("code",[_._v("SYN 报文")]),_._v("是否正确，所以正常返回。而客户端收到会进行检测，发现是旧的报文，就会返回"),e("code",[_._v("RST 报文")]),_._v("。")]),_._v(" "),e("h4",{attrs:{id:"_4-第三次握手失败了怎么办？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-第三次握手失败了怎么办？"}},[_._v("#")]),_._v(" 4.第三次握手失败了怎么办？")]),_._v(" "),e("p",[_._v("这个问题在网上找到的答案质量参差不齐，翻阅了"),e("code",[_._v("rfc793")]),_._v("，仔细研究后，最终整理出以下答案：")]),_._v(" "),e("p",[_._v("首先考虑失败的情况：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucbpugxj30uk0qeae7.jpg",alt:"ACK报文丢失导致第三次握手失败"}})]),_._v(" "),e("p",[_._v("当客户端收到服务端的"),e("code",[_._v("SYNACK")]),_._v("应答后，其状态变为"),e("code",[_._v("ESTABLISHED")]),_._v("，并会发送"),e("code",[_._v("ACK")]),_._v("包给服务端，准备发送数据了。如果此时"),e("code",[_._v("ACK")]),_._v("在网络中丢失（如上图所示），过了超时计时器后，那么服务端会重新发送"),e("code",[_._v("SYNACK")]),_._v("包，重传次数根据"),e("code",[_._v("/proc/sys/net/ipv4/tcp_synack_retries")]),_._v("来指定，默认是"),e("code",[_._v("5")]),_._v("次。如果重传指定次数到了后，仍然未收到"),e("code",[_._v("ACK")]),_._v("应答，那么一段时间后，"),e("code",[_._v("Server")]),_._v("自动关闭这个连接。")]),_._v(" "),e("p",[_._v("问题就在这里，客户端已经认为连接建立，而服务端则可能处在"),e("code",[_._v("SYN-RCVD")]),_._v("或者"),e("code",[_._v("CLOSED")]),_._v("，接下来我们需要考虑这两种情况下服务端的应答：")]),_._v(" "),e("ul",[e("li",[_._v("服务端处于"),e("code",[_._v("CLOSED")]),_._v("，当接收到连接已经关闭的请求时，服务端会返回"),e("code",[_._v("RST 报文")]),_._v("，客户端接收到后就会关闭连接，如果需要的话则会重连，那么那就是另一个三次握手了。")]),_._v(" "),e("li",[_._v("服务端处于"),e("code",[_._v("SYN-RCVD")]),_._v("，此时如果接收到正常的"),e("code",[_._v("ACK 报文")]),_._v("，那么很好，连接恢复，继续传输数据；如果接收到写入数据等请求呢？注意了，此时写入数据等请求也是带着"),e("code",[_._v("ACK 报文")]),_._v("的，实际上也能恢复连接，使服务器恢复到"),e("code",[_._v("ESTABLISHED")]),_._v("状态，继续传输数据。")])]),_._v(" "),e("p",[_._v("这个结论也可以在"),e("code",[_._v("STACKFLOW")]),_._v("上找到验证：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9quch3gigj314o0syguu.jpg",alt:"What if a TCP handshake segment is lost?"}})]),_._v(" "),e("p",[_._v("上图圈住的部分：")]),_._v(" "),e("blockquote",[e("p",[_._v("总的来说，如果一个"),e("code",[_._v("ACK 报文")]),_._v("丢失了，但它的下一个数据包没有丢失，那么连接正常，否则，连接会被重置。")])]),_._v(" "),e("h4",{attrs:{id:"_5-知道syn攻击吗？如何防范？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-知道syn攻击吗？如何防范？"}},[_._v("#")]),_._v(" 5.知道SYN攻击吗？如何防范？")]),_._v(" "),e("p",[_._v("所谓"),e("code",[_._v("SYN 洪泛攻击")]),_._v("，就是利用"),e("code",[_._v("SYNACK 报文")]),_._v("的时候，服务器会为客户端请求分配缓存，那么黑客（攻击者），就可以使用一批虚假的"),e("code",[_._v("ip")]),_._v("向服务器大量地发建立"),e("code",[_._v("TCP 连接")]),_._v("的请求，服务器为这些"),e("code",[_._v("虚假ip")]),_._v("分配了缓存后，处在"),e("code",[_._v("SYN_RCVD")]),_._v("状态，存放在"),e("code",[_._v("半连接队列")]),_._v("中；另外，服务器发送的请求又不可能得到回复（ip都是假的，能回复就有鬼了），只能不断地"),e("code",[_._v("重发请求")]),_._v("，直到达到设定的时间/次数后，才会关闭。")]),_._v(" "),e("p",[_._v("服务器不断为这些"),e("code",[_._v("半开连接")]),_._v("分配资源（但从未使用），导致服务器的连接资源被消耗殆尽，不过所幸，我们可以使用"),e("code",[_._v("SYN Cookie")]),_._v("进行有效地防御。")]),_._v(" "),e("blockquote",[e("p",[_._v("所谓的"),e("code",[_._v("SYN Cookie")]),_._v("防御系统，与前面接收到"),e("code",[_._v("SYN 报文")]),_._v("就分配缓存不同，此时暂不分配资源；同时利用"),e("code",[_._v("SYN 报文")]),_._v("的"),e("code",[_._v("源")]),_._v("和"),e("code",[_._v("目的地IP")]),_._v("和"),e("code",[_._v("端口")]),_._v("，以及服务器存储的一个"),e("code",[_._v("秘密数")]),_._v("，使用它们进行散列，得到"),e("code",[_._v("server_isn")]),_._v("，然后附着在"),e("code",[_._v("SYNACK 报文")]),_._v("中发送给客户端，接下来就是对"),e("code",[_._v("ACK 报文")]),_._v("进行判断，如果其返回的"),e("code",[_._v("ack")]),_._v("字段正好等于"),e("code",[_._v("server_isn + 1")]),_._v("，说明这是一个合法的"),e("code",[_._v("ACK")]),_._v("，那么服务器才会为其生成一个具有套接字的全开的连接。")])]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9qucdg12wj315l0u0dtl.jpg",alt:"SYN Cookie 防御"}})]),_._v(" "),e("blockquote",[e("p",[_._v("当然这种方案也有一定"),e("code",[_._v("缺点")]),_._v("，最明显的就是"),e("code",[_._v("服务器不保存连接的半开状态")]),_._v("，就"),e("code",[_._v("丧失")]),_._v("了"),e("code",[_._v("重发SYN-ACK消息")]),_._v("的能力，这一方面会降低正常用户的连接成功率，另一方面会导致某些情况下正常通信的双方会对连接是否成功打开产生误解，如客户端发给服务端的第三次握手消息（"),e("code",[_._v("ACK")]),_._v("）半路遗失，客户端认为连接成功了，服务端认为没收到"),e("code",[_._v("ACK")]),_._v("，连接没成功，这种情况就需要上层应用采取策略特别处理了。")])]),_._v(" "),e("h4",{attrs:{id:"_6-（isn）是固定的吗？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-（isn）是固定的吗？"}},[_._v("#")]),_._v(" 6.（ISN）是固定的吗？")]),_._v(" "),e("p",[_._v("不固定，"),e("code",[_._v("client_isn")]),_._v("是随机生成的，而"),e("code",[_._v("server_isn")]),_._v("则需要根据"),e("code",[_._v("SYN 报文")]),_._v("中的"),e("code",[_._v("源、ip和端口")]),_._v("，加上服务器本身的"),e("code",[_._v("密码数")]),_._v("进行相同的散列得到，显然这也不是固定的。")]),_._v(" "),e("h4",{attrs:{id:"_7-三次握手过程中可以携带数据吗？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-三次握手过程中可以携带数据吗？"}},[_._v("#")]),_._v(" 7.三次握手过程中可以携带数据吗？")]),_._v(" "),e("p",[_._v("讲过程的时候其实已经讲了，"),e("code",[_._v("第三次握手是可以携带数据的")]),_._v("，而前两次不行。")]),_._v(" "),e("h4",{attrs:{id:"_8-关于-https-的认证过程？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-关于-https-的认证过程？"}},[_._v("#")]),_._v(" 8. 关于 https 的认证过程？")]),_._v(" "),e("p",[_._v("限于篇幅，此处暂时不讲，留意后续文章。")]),_._v(" "),e("h2",{attrs:{id:"四次挥手"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四次挥手"}},[_._v("#")]),_._v(" 四次挥手")]),_._v(" "),e("p",[_._v("和"),e("code",[_._v("握手")]),_._v("类似，每次"),e("code",[_._v("挥手")]),_._v("也代表一次报文的发出和接收。")]),_._v(" "),e("h3",{attrs:{id:"过程描述-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#过程描述-2"}},[_._v("#")]),_._v(" 过程描述")]),_._v(" "),e("p",[_._v("因为自顶向上这本书里面的图比较简略，这里采用谢希仁版本的计算机网络中的图：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexpkgg7j30xd0nq0xb.jpg",alt:"计算机网络-谢希仁-四次挥手"}})]),_._v(" "),e("p",[_._v("首先，当前客户端和服务器的状态都为"),e("code",[_._v("ESTABLISHED")]),_._v("，接下来我们详细讲解下上图的过程：")]),_._v(" "),e("ul",[e("li",[e("p",[_._v("客户主机发起连接释放的请求，设置"),e("code",[_._v("FIN")]),_._v("为"),e("code",[_._v("1")]),_._v("，当然，序号"),e("code",[_._v("seq")]),_._v("也会带上，这里假设为"),e("code",[_._v("u")]),_._v("；发送完毕后，客户端进入 "),e("code",[_._v("FIN-WAIT-1")]),_._v(" 状态。")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexp23znj314u0ewgo0.jpg",alt:"第一次挥手：FIN报文"}})])]),_._v(" "),e("li",[e("p",[_._v("服务端接收到"),e("code",[_._v("FIN 报文")]),_._v("后，会返回一个"),e("code",[_._v("ACK 报文")]),_._v("回去，此时设置"),e("code",[_._v("ACK")]),_._v("为"),e("code",[_._v("1")]),_._v("，"),e("code",[_._v("确认号")]),_._v("为"),e("code",[_._v("u + 1")]),_._v("；表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。发送完毕后，服务器端进入 "),e("code",[_._v("CLOSE-WAIT")]),_._v(" 状态，客户端接收到这个确认包之后，进入 "),e("code",[_._v("FIN-WAIT-2")]),_._v(" 状态，等待服务器端关闭连接。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexom2b3j314e0eqjtu.jpg",alt:"第二次挥手：ACK报文"}})])]),_._v(" "),e("li",[e("p",[_._v("服务器端准备好关闭连接时，向客户端发送结束连接请求，"),e("code",[_._v("FIN")]),_._v(" 置为"),e("code",[_._v("1")]),_._v("；发送完毕后，服务器端进入 "),e("code",[_._v("LAST-ACK")]),_._v(" 状态，等待来自客户端的最后一个"),e("code",[_._v("ACK")]),_._v("。")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexmrc5pj316i0f6tbe.jpg",alt:"第三次挥手：FIN报文"}})])]),_._v(" "),e("li",[e("p",[_._v("客户端接收到服务端传来的"),e("code",[_._v("FIN 报文")]),_._v("后，知道服务器已经准备好关闭了，发送一个确认包，并进入 "),e("code",[_._v("TIME-WAIT")]),_._v("状态，等待可能出现的要求重传的"),e("code",[_._v("ACK 报文")]),_._v("；服务器端接收到这个确认包之后，关闭连接，进入 "),e("code",[_._v("CLOSED")]),_._v(" 状态。")]),_._v(" "),e("p",[_._v("客户端等待了某个固定时间（两个最大段生命周期，"),e("code",[_._v("2MSL")]),_._v("，2 Maximum Segment Lifetime）之后，没有收到服务器端的 "),e("code",[_._v("ACK")]),_._v(" ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 "),e("code",[_._v("CLOSED")]),_._v(" 状态。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexnbdd6j31460f0tb6.jpg",alt:"第四次挥手：ACK报文"}})])])]),_._v(" "),e("p",[_._v("这里我们再来看下"),e("code",[_._v("rfc793")]),_._v("中关于四次挥手的简单例子：")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9rexnp4llj30to0h4mz8.jpg",alt:"rfc793-正常的关闭例子"}})]),_._v(" "),e("h3",{attrs:{id:"细节拓展-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#细节拓展-2"}},[_._v("#")]),_._v(" 细节拓展")]),_._v(" "),e("ul",[e("li",[_._v("四次挥手重要的是"),e("code",[_._v("TIME-WAIT")]),_._v("状态，为什么需要这个状态呢？")])]),_._v(" "),e("p",[_._v("要确保服务器是否已经收到了我们的"),e("code",[_._v("ACK 报文")]),_._v("，如果没有收到的话，服务器会重新发"),e("code",[_._v("FIN 报文")]),_._v("给客户端，那么客户端再次收到"),e("code",[_._v("FIN 报文")]),_._v("之后，就知道之前的 "),e("code",[_._v("ACK 报文")]),_._v("丢失了，就会再次发送"),e("code",[_._v("ACK 报文")]),_._v("。")]),_._v(" "),e("h3",{attrs:{id:"问题深究-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题深究-2"}},[_._v("#")]),_._v(" 问题深究")]),_._v(" "),e("h4",{attrs:{id:"_1-为什么握手只要三次，挥手却要四次？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么握手只要三次，挥手却要四次？"}},[_._v("#")]),_._v(" 1.为什么握手只要三次，挥手却要四次？")]),_._v(" "),e("p",[_._v("关键就在中间两步。")]),_._v(" "),e("ul",[e("li",[_._v("建立连接时，当服务器收到客户端的"),e("code",[_._v("SYN 报文")]),_._v("后，可以直接发送"),e("code",[_._v("SYNACK 报文")]),_._v("。其中"),e("code",[_._v("ACK")]),_._v("是用来应答的，"),e("code",[_._v("SYN")]),_._v("是用来同步的。")]),_._v(" "),e("li",[_._v("但是关闭连接时，当服务器收到"),e("code",[_._v("FIN 报文")]),_._v("时，很可能并不会立即关闭"),e("code",[_._v("SOCKET")]),_._v("，所以只能先回复一个"),e("code",[_._v("ACK 报文")]),_._v("，告诉客户端，“你发的"),e("code",[_._v("FIN 报文")]),_._v("我收到了”。只有等到服务器所有的报文都发送/接收完了，我才能发送"),e("code",[_._v("FIN 报文")]),_._v("，因此不能一起发送，需要四次握手。")])]),_._v(" "),e("h4",{attrs:{id:"_2-为什么-time-wait-状态需要经过-2msl-才能转换到-close-状态？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-为什么-time-wait-状态需要经过-2msl-才能转换到-close-状态？"}},[_._v("#")]),_._v(" 2.为什么 TIME_WAIT 状态需要经过 2MSL 才能转换到 CLOSE 状态？")]),_._v(" "),e("ul",[e("li",[_._v("第一，为了保证客户端发送的最后一个"),e("code",[_._v("ACK 报文")]),_._v("能够到达服务器。我们必须假设网络是不可靠的，"),e("code",[_._v("ACK 报文")]),_._v("可能丢失。如果服务端发出"),e("code",[_._v("FIN 报文")]),_._v("后没有收到"),e("code",[_._v("ACK 报文")]),_._v("，就会重发"),e("code",[_._v("FIN 报文")]),_._v("，此时处于"),e("code",[_._v("TIME-WAIT")]),_._v("状态的客户端就会重发"),e("code",[_._v("ACK 报文")]),_._v("。当然，客户端也不能无限久的等待这个可能存在的"),e("code",[_._v("FIN 报文")]),_._v("，因为如果服务端正常接收到了"),e("code",[_._v("ACK 报文")]),_._v("后是不会再发"),e("code",[_._v("FIN 报文")]),_._v("的。因此，客户端需要设置一个计时器，那么等待多久最合适呢？所谓的"),e("code",[_._v("MSL")]),_._v("（Maximum Segment Lifetime）指一个报文在网络中最大的存活时间，2MSL就是"),e("strong",[_._v("一个发送和一个回复所需的最大时间")]),_._v("。如果直到"),e("code",[_._v("2MSL")]),_._v("时间后，客户端都没有再次收到"),e("code",[_._v("FIN 报文")]),_._v("，那么客户端推断"),e("code",[_._v("ACK 报文")]),_._v("已经被服务器成功接收，所以结束"),e("code",[_._v("TCP 连接")]),_._v("。")]),_._v(" "),e("li",[_._v("第二，防止"),e("strong",[_._v("已失效的连接请求报文段")]),_._v("出现在新的连接中。客户端在发送完最后一个"),e("code",[_._v("ACK 报文")]),_._v("后，再经过时间"),e("code",[_._v("2MSL")]),_._v("，就可以使由于网络不通畅产生的滞留报文段失效。这样下一个新的连接中就不会出现旧的连接请求报文。")])]),_._v(" "),e("h2",{attrs:{id:"致谢"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#致谢"}},[_._v("#")]),_._v(" 致谢")]),_._v(" "),e("p",[_._v("以下书籍和博文为本文的撰写提供不少帮助：")]),_._v(" "),e("blockquote",[e("p",[_._v("计算机网络 (第7版) 谢希仁")]),_._v(" "),e("p",[_._v("计算机网络-自顶向下方法 第七版")]),_._v(" "),e("p",[_._v("rfc793 原文连接：https://tools.ietf.org/rfc/rfc793.txt")]),_._v(" "),e("p",[_._v("https://hit-alibaba.github.io/interview/basic/network/TCP.html Github【HIT-Alibaba/interview】")]),_._v(" "),e("p",[_._v("https://stackoverflow.com/questions/16259774/what-if-a-tcp-handshake-segment-is-lost StackFlow")]),_._v(" "),e("p",[_._v("https://mp.weixin.qq.com/s/8t_KFtrrBkFyZKPJg_y6pw 公众号【苦逼的码农】")]),_._v(" "),e("p",[_._v("https://www.cnblogs.com/Andya/p/7272462.html 博客园 【Andya】")]),_._v(" "),e("p",[_._v("https://www.cnblogs.com/popduke/p/5823801.html 博客园 【YonnyHao】")]),_._v(" "),e("p",[_._v("https://blog.csdn.net/scuzoutao/article/details/81774100 csdn博主【邹啊涛】")]),_._v(" "),e("p",[_._v("https://blog.csdn.net/qq_38950316/article/details/81087809 csdn博主 【青柚_】")])]),_._v(" "),e("p",[_._v("读者们也可将上述书籍和博文作为延伸阅读。")]),_._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1g9g8m4illgj30lg098aao.jpg",alt:"img"}})])])}),[],!1,null,null,null);v.default=t.exports}}]);